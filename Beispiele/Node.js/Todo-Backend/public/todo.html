<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO App</title>
    <link href="https://bootswatch.com/5/spacelab/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1>Die beste TODO App im Netz v2.0!</h1>
        <form>
            <div class="input-group">
                <input class="form-control" id="new-todo-text" type="text" name="newtodo"/>
                <button id="todo-merken-button" class="btn btn-primary">Todo Merken</button>
            </div>
        </form>
        <br/>
        <ul class="list-group" id="todo-list"></ul>
    </div>
    <script>
        // Einsprungpunkt: Sobald die Seite fertig geladen wird, wird die Funktion 'initTodoApp' aufgerufen.
        window.addEventListener('DOMContentLoaded', initTodoApp);

        async function initTodoApp() {
            // Den "Todo Merken" Button aus dem DOM selektieren.
            const createTodoItemButton = document.querySelector("#todo-merken-button");
            // Einen click event listener hinterlegen, der beim klicken auf den button die funktion "createTodoItem" aufruft
            createTodoItemButton.addEventListener("click", createTodoItem);

            // Verhindern dass das Formular beim drücken von "enter" abgeschickt wird.
            document.querySelector("form").addEventListener("submit", (event) => event.preventDefault());

            await loadAndRenderTodoList();
        }

        async function loadAndRenderTodoList() {
            // Bereits angelegte TodoListe aus dem LocalStorage laden
            const todoList = await loadTodoListFromBackend();
            // Geladene TodoList in HTML rendern
            renderTodoList(todoList);

            window.setTimeout(loadAndRenderTodoList, 5000);
        }

        // Diese Funktion wird aufgerufen wenn der "Todo Merken" Button geklickt wird.
        function createTodoItem() {
            // Das Input-Feld aus dem DOM holen
            const input = document.querySelector("#new-todo-text");
            // Den Text aus dem Input-Feld holen
            const todoText = input.value;

            // Sofern kein Text eingegeben wurde, nichts machen.
            if(todoText == "") {
                return;
            }

            let todoItemData = {
                title: todoText,
                id: nanoid(),
                created: new Date().toISOString(),
            };

            // Ein neues TodoItem Element erzeugen
            const todoItem = renderTodoListItem(todoItemData);

            // Das <ul>-Element aus dem DOM holen
            const todoList = document.querySelector("ul");
            // An das <ul>-Element das neu erzeugte TodoItem Element anhängen
            todoList.append(todoItem);

            // Das neue Todo im LocalStoarge speichern
            addTodoItemToBackend(todoItemData);

            // Das Eingabfeld leeren
            input.value = "";
        }

        // Fügt ein TodoItem an die Liste der gespeicherten TodoItems im LocalStorage hinzu
        async function addTodoItemToBackend(newTodoItem) {
            var response = await fetch("/api/v1/todos", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(newTodoItem)
            });
            // Sämtliche Fehlerbehandlung wird erstmal ignoriert. :)
        }

        // Entfernt ein TodoItem aus der Liste der gespeicherten TodoItems im LocalStorage
        async function removeTodoItemFromBackend(todoItemToRemove) {
            const deleteUrl = "/api/v1/todos/" + todoItemToRemove.id;

            var response = await fetch(deleteUrl, {
                method: "DELETE"
            });
        }

        // Speichert eine Liste von TodoItems im LocalStorage
        function saveTodoListToLocalStorage(todoItemsToStore) {
            // Die übergebene Liste in einen JSON string umwandeln
            const todoListData = JSON.stringify(todoItemsToStore);
            // Den JSON string mit dem key "todo-list" im LocalStorage ablegen.
            window.localStorage.setItem("todo-list", todoListData);
        }

        // Lädt eine Liste von TodoItems vom LocalStorage.
        // Liefert eine leere Liste, sofern im LocalStorage noch keine Daten gespeicehrt wurden.
        async function loadTodoListFromBackend() {
            var response = await fetch("/api/v1/todos");
            var todoList = await response.json();
            return todoList;
        }

        // Erzeugt für jeden eintrag in der TodoListe ein passenden TodoItem
        function renderTodoList(todoList) {
            // Holen des <ul>-Elements aus dem DOM
            const list = document.querySelector("#todo-list");
            list.replaceChildren();

            // Funktionale Version einer for-Schleife
            todoList.forEach((todoItem) => {
                // Erzeuge aus dem aktuellen Schleifenelement ein neues <li>-Element
                var todoItemElement = renderTodoListItem(todoItem);

                // Füge das neue <li>-Element an die <ul>-Liste an.
                list.append(todoItemElement);
            });
        }

        // Erzeugt ein <li>-Element für ein neues TodoItem
        function renderTodoListItem(todoItem) {
            var newTodoItemElement = document.createElement("li");
            newTodoItemElement.innerText = todoItem.title;
            // An das erzeugte <li>-Element ein "class" Attribut hinzufügen
            newTodoItemElement.setAttribute("class", "list-group-item");

            // Einen Click-Eventhandler registrieren der beim klicken auf das Element das Element entfernt.
            newTodoItemElement.addEventListener("click", async () => {
                newTodoItemElement.remove();

                await removeTodoItemFromBackend(todoItem);
            });

            return newTodoItemElement;
        }
    </script>

<script type="module">
    import { nanoid } from 'https://cdn.jsdelivr.net/npm/nanoid/nanoid.js';
    // make nanoid globally available
    window.nanoid = nanoid;
</script>
</body>
</html>
